<!doctype html>
<html style="font-size: 10pt;" lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <meta name="config">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet"/>
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/5.0.0/mdb.min.css" rel="stylesheet"/>
    <!-- MDB -->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/5.0.0/mdb.min.js"></script>
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.1.js"
            integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>

    <!-- AJAX and socketio -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"
            integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k"
            crossorigin="anonymous"></script>

    <!-- Toaster -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <!-- import local files -->
    <link rel="stylesheet" href="{{ url_for('static',filename='css/home.css') }}" media="screen">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/floatChat.css') }}" media="screen">

    <title>{% block title %}TERMINAL {{ g_config.terminal }}{% endblock %}</title>

    <script>
        toastr.options = {
            closeButton: true,
            debug: true,
            newestOnTop: false,
            progressBar: true,
            preventDuplicates: true,
            onclick: null,
            showDuration: "2000",
            hideDuration: "1000",
            timeOut: "3000",
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",
            hideMethod: "fadeOut"
        };

        if (!document.querySelector('meta[name="config"]').content) {
            let meta = document.querySelector('meta[name="config"]');

            $.ajax({
                async: false,
                type: 'POST',
                url: '{{ url_for("get_globals") }}',
                contentType: 'application/json;charset=UTF-8',
                success: function (res) {
                    meta.content = JSON.stringify(res);
                }
            });
        }
        const myChatConfig = JSON.parse(document.querySelector('meta[name="config"]').content);
        const myRoomID = myChatConfig.id;
        const myDispName = myChatConfig.title;
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        var g_lang = myChatConfig.lang
    </script>

    {% block chat_js %}
        <!-- For self-socket -->
        <script type="text/javascript">
            socket.on('connect', function () {
                socket.emit('msg_to_backend', {
                    update: `'${myDispName}' is on page {{ request.path }}`
                })
            })

            socket.on('response_to_frontend', function (msg) {
                //console.log(msg)
                handleMessageReception(msg)
            })

            socket.on('usr_auth', function (msg) {
                if (msg.usr.toLowerCase() === "empty") {
                    toastr.success(`user logout`);
                } else {
                    toastr.success(`user ${msg.usr} login`);
                }
                {% if request.path == "/lab_control" %}
                    clearInterval(countDownInterval);
                    $.post("{{ url_for('lab_control') }}", {
                        auth: "success"
                    });
                    stopBootLoop = true;
                    alert(`Hello ${msg.usr}! Welcome to the lab`)
                    toastr.success('Successful authentication');
                    setTimeout( () => {
                        document.location.href = "/"}
                    , 1500);
                {% else %}
                    loadControlPanel(msg.data)
                {% endif %}
            })

            socket.on("airlock_fe", function (msg) {
                console.log(`airlock ${msg}`)
                toastr.warning(`airlock laser is ${msg.status}`);
                loadControlPanel(msg.data, msg.status);
            })

            socket.on("boot_fe", function (msg) {
                console.log(`usb boot: ${msg}`)
                if (msg.status === "disconnect") {
                    toastr.error(`Shutdown in 5 Seconds`);
                    setTimeout(function () {
                        window.location.href = "/";
                    }, 5000);
                }
            })

            socket.on('samples_updates', function (msg) {
                //console.log(msg)
                {% if request.path != "/gas_control" and request.path != "/gas_analysis" %}
                    toastr.success('There is an update in samples status');
                {% endif %}
            })

            function handleMessageReception(msg) {
                if (typeof msg.user_name !== 'undefined') {
                    $('#msg_holder').prepend(
                        `<div><b style="color: #000"> ${msg.user_name}: </b>
                     <p style="display: inline; color: white">${msg.message}</p></div>`);

                    if (msg.user_name !== myRoomID) {
                        {% if request.path != "/chat_control" %}
                            toastr.info('You have received an new message');
                        {% endif %}

                        // update floating container
                        if (document.getElementById("floatMsgContainer")) {
                            receiveNewMessage(msg.user_name, msg.message);
                        }
                    }
                }
            }
        </script>
    {% endblock %}

    {% block head %}
    {% endblock %}
</head>

<body class="body bg-dark" data-lang="en">

{% include "header.html" %}

<section id="control-section">
    <div id="content">
        {% block content %}
        {% endblock %}
    </div>
</section>

<script src="{{ url_for('static',filename='js/fns.js') }}">
</script>

<script type="text/javascript">
    $(function () {
        let rb = document.getElementById("rb_" + g_lang)
        if (rb) {
            rb.checked = true;
        }
    });

    function loadControlPanel(jsonResponse, airlockStatus = "") {
        let CPanel = document.getElementById("ControlPanel")
        let PContainer = document.getElementById("posts-container")
        let resTxt = ""

        if (CPanel) {
            //CPanel.innerHTML = ""
            for (let jsonResponseElement of jsonResponse.btns) {
                resTxt += jsonResponseElement.html
            }
            CPanel.innerHTML = resTxt;

            let airlock = airlockStatus || "{% if airlock %}{{ airlock }}{% endif %}";
            let airlockAuth = "{% if airlock_auth %}{{ airlock_auth }}{% endif %}";
            if (airlock === "error") {
                let air_elem = jsonResponse.btns.find(x => x.id === '{{ airlock_id }}');
                disableOption(air_elem, "<p style='color: white; font-size: 25pt'>ERROR 432</p>", "rgba(255,0,0,0.6)");
            }

            for (let jsonResponseElement of jsonResponse.btns) {
                if (airlockAuth === "failed" && jsonResponseElement.id !== "{{ airlock_id }}") {
                    disableOption(jsonResponseElement, "Authentication failed");
                } else if (airlockAuth === "success" && jsonResponseElement.id === "{{ airlock_id }}") {
                    disableOption(jsonResponseElement, "success", "rgba(0, 255, 0, 0.6)");
                } else if (jsonResponseElement.auth) {
                    disableOption(jsonResponseElement, jsonResponse.auth_msg);
                }
            }


        } else if (PContainer) {
            let resTxt = ""
            for (const post of jsonResponse) {
                resTxt += `<div class="card col-md-6 m-sm-auto">
                <div class="card-body">
                    <h5 class="card-title">
                        <a class="stretched-link"
                           href=${post.url}>
                            ${post.title}
                        </a>
                    </h5>
                    <p class="card-text"> ${post.exert} </p>
                    <small> ${post.date} </small>
                </div>
            </div>`
            }
            PContainer.innerHTML = resTxt
        }
    }
</script>
{% block add_js %}

{% endblock %}
</body>

</html>